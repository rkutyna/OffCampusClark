{% extends "base_generic.html" %}
{% block content %}
{% load static %}
<h2>Inbox</h2>
<ul id="message-list">
    {% for message in messages %}
    <li>
        <a href="{% url 'read_message' message.id %}">{{ message.sender }}: {{ message.content|truncatewords:10 }}</a>
        {% if not message.is_read %}<strong>(unread)</strong>{% endif %}
    </li>
    {% endfor %}
</ul>

<h2>Start a new chat</h2>
<ul>
    {% for user in users %}
    <li>
        <a href="{% url 'send_message' user.username %}">Chat with {{ user.username }}</a>
    </li>
    {% endfor %}
</ul>

<script>
    const inboxSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/inbox/'
    );

    inboxSocket.onopen = function(e) {
        console.log('WebSocket connection opened.');
    };

    inboxSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data['message'];
        const sender = data['sender'];

        const messageList = document.getElementById('message-list');
        const messageElement = document.createElement('li');
        const messageLink = document.createElement('a');
        messageLink.href = '{% url 'read_message' 0 %}'.replace('0', data['message_id']);
        messageLink.textContent = `${sender}: ${message}`;
        messageElement.appendChild(messageLink);

        if (!data['is_read']) {
            const unreadSpan = document.createElement('strong');
            unreadSpan.textContent = ' (unread)';
            messageElement.appendChild(unreadSpan);
        }

        messageList.appendChild(messageElement);
    };

    inboxSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly:', e);
    };

    inboxSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
</script>
{% endblock %}